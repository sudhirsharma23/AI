# ImageTextExtractor - Azure Architecture Diagram

## High-Level Architecture

```
???????????????????????????????????????????????????????????????????????????????????
?   FILE UPLOAD & TRIGGER        ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????
    ?  User/App    ?
    ?  Upload TIF  ?
    ????????????????
    ?
         ? HTTPS
           ?
    ????????????????????????????????????????????????????????????????????
    ?  Azure Blob Storage           ?
    ?  ???????????????  ????????????????  ?????????????????       ?
    ?  ?input/    ?  ? processed/   ?  ? output/   ?          ?
    ?  ? - pending/  ??  - archive/  ?  ?  - v1-schema/ ?      ?
    ?  ? - processing?  ?        ?  ?  - v2-dynamic/?   ?
  ?  ? - failed/   ??          ?  ?  - ocr/       ?      ?
    ?  ???????????????  ????????????????  ?????????????????          ?
    ????????????????????????????????????????????????????????????????????
      ?
     ? Blob Created Event
            ?
  ????????????????
             ? Event Grid   ?
              ? System Topic ?
  ????????????????
                ?
  ? Event Subscription
            ?

???????????????????????????????????????????????????????????????????????????????????
?        PROCESSING ORCHESTRATION               ?
???????????????????????????????????????????????????????????????????????????????????

         ????????????????????????????
       ?  Azure Function App  ?
            ?  (ProcessTifTrigger)     ?
   ?     ?
                ?  1. Validate event       ?
      ?  2. Move file to         ?
?     processing/      ?
         ?  3. Create job metadata  ?
 ?  4. Trigger Container    ?
         ????????????????????????????
        ?
           ? Container API Call
            ?
      ????????????????????????????
                ?  Azure Container         ?
    ?  Instances (ACI)         ?
      ?      ?
      ?  Container Group:        ?
        ?  imageextractor-{jobId}  ?
           ?  ?
 ?  Resources:              ?
       ?  - CPU: 1 core           ?
            ?  - Memory: 1.5 GB     ?
          ?  - Restart: Never        ?
         ????????????????????????????
       ?
  ?
         ?

???????????????????????????????????????????????????????????????????????????????????
?      IMAGE PROCESSING PIPELINE       ?
???????????????????????????????????????????????????????????????????????????????????

    ???????????????????????????????????????????????????????????????????
    ?     Container Instance Workflow ?
    ?        ?
    ?  Step 1: Download TIF from Blob Storage         ?
    ?          ?      ?
    ?  Step 2: Send to Azure Content Understanding API (OCR)     ?
    ?          ? ?
    ?  Step 3: Extract markdown text from OCR results           ?
    ?       ??
    ?  Step 4: Process with Azure OpenAI GPT-4          ?
    ?     ??? V1: Schema-based extraction       ?
    ???? V2: Dynamic extraction             ?
    ??            ?
    ?  Step 5: Generate JSON results        ?
    ?      ??? final_output_*_v1_schema.json ?
    ?       ??? final_output_*_v2_dynamic.json     ?
    ?          ?         ?
    ?  Step 6: Upload results to Blob Storage        ?
    ?  ?           ?
    ?  Step 7: Move source file to archive        ?
    ?          ?      ?
    ?  Step 8: Update job status   ?
    ???????????????????????????????????????????????????????????????????
    ?
          ?

???????????????????????????????????????????????????????????????????????????????????
?         AI SERVICES & PROCESSING       ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????????????   ????????????????????????
    ?  Azure Content   ?  ?  Azure OpenAI    ?
    ?  Understanding     ?      ?  (GPT-4o-mini)       ?
    ?  (Prebuilt Analyzer) ?           ?        ?
 ?             ?      ?  • V1: Schema-based  ?
    ?  • OCR Extraction  ?????????????    extraction        ?
    ?  • Layout Analysis   ?   ?  • V2: Dynamic ?
    ?  • Table Detection   ?     ?    extraction ?
    ????????????????????????   ????????????????????????
 ?
           ?
               ?

???????????????????????????????????????????????????????????????????????????????????
?           DATA STORAGE & PERSISTENCE  ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????????????         ????????????????????????
    ?  Azure SQL Database  ?    OR     ?  Azure Cosmos DB     ?
  ?            ?       ?    ?
    ?  Tables:  ?  ?  Containers:         ?
    ?  • ProcessingJobs    ?   ?• extraction-results?
    ?  • ExtractionResults ?  ?  • job-metadata      ?
    ?  • Buyers  ?           ??
    ?  • Sellers           ?       ?  Partition Key:    ?
    ?           ??  /jobId          ?
    ????????????????????????           ????????????????????????
       ?            ?
   ?????????????????????????????????????
        ?
       ?

???????????????????????????????????????????????????????????????????????????????????
?  MONITORING & OBSERVABILITY    ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????????????           ????????????????????????
    ?  Application ?      ?  Log Analytics     ?
    ?  Insights     ?   ?  Workspace      ?
    ?           ?   ?   ?
    ?  • Custom Events     ?????????????  • Query Logs        ?
    ?  • Metrics       ??  • Create Dashboards ?
    ?  • Dependencies      ?   ?  • Set Alerts        ?
    ?  • Failures  ?           ?    ?
    ????????????????????????           ????????????????????????
 ?                 ?
  ?????????????????????????????????????
   ?
   ?
                ????????????????
      ?   Power BI   ?
             ?  Dashboards  ?
   ?        ?
              ?  • Job Stats ?
                  ?  • Success   ?
    ?    Rate   ?
          ?  • Processing?
     ?  Time    ?
           ????????????????

???????????????????????????????????????????????????????????????????????????????????
?    SECURITY & SECRETS MANAGEMENT         ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????????????   ????????????????????????
    ?  Azure Key Vault     ??  Managed Identity    ?
    ?          ?   ?       ?
    ?  Secrets:    ?           ?  • System-assigned   ?
    ?  • AzureOpenAIKey    ?????????????  • Access Control    ?
    ?  • AzureEndpoint     ?         ?  • RBAC   ?
    ?  • StorageConnStr ?           ?       ?
    ????????????????????????   ????????????????????????

???????????????????????????????????????????????????????????????????????????????????
?CI/CD PIPELINE         ?
???????????????????????????????????????????????????????????????????????????????????

    ????????????????
    ?   GitHub     ?
    ?  Repository  ?
    ????????????????
         ?
  ? Push to main
     ?
????????????????????????????????????????????????
    ?    GitHub Actions / Azure DevOps          ?
?              ?
    ?  1. Build .NET 9 application           ?
    ?  2. Run unit tests            ?
    ?  3. Build Docker image   ?
    ?  4. Push to Azure Container Registry         ?
    ?  5. Deploy Function App     ?
    ?  6. Deploy Infrastructure (Bicep)      ?
    ?  7. Run smoke tests        ?
    ????????????????????????????????????????????????
                 ?
      ? Deployment
                   ?
    ????????????????????????????
    ?   Azure Container        ?
    ?   Registry (ACR)         ?
    ?     ?
    ?  Images:          ?
    ?  • imageextractor:latest ?
    ?  • imageextractor:v1.0.0 ?
    ?  • imageextractor:{sha}  ?
    ????????????????????????????

```

## Detailed Component Breakdown

### 1. Event-Driven Flow
```
File Upload ? Blob Created Event ? Event Grid ? Function Trigger ? Container Instance
```

### 2. Processing States
```
???????????    ??????????????    ?????????????    ???????????
? Pending ? -> ? Processing ? -> ? Completed ? or ? Failed  ?
???????????    ??????????????    ?????????????    ???????????
     ?     ?    ?    ?
     ?          ?            ?  ?
input/pending  input/processing  processed/archive  input/failed
```

### 3. Data Flow
```
TIF File ??? OCR API ??? Markdown ??? OpenAI ??? JSON ??? Storage ??? Database
         (5-10s)     (15-20s)     (10-30s)   (1-2s)    (1-2s)    (1s)

Total Time: ~30-60 seconds per TIF file
```

## Scalability Patterns

### Horizontal Scaling
```
Multiple TIF files uploaded simultaneously:

File 1 ??? Event 1 ??? Function 1 ??? Container Instance 1
File 2 ??? Event 2 ??? Function 2 ??? Container Instance 2
File 3 ??? Event 3 ??? Function 3 ??? Container Instance 3
...
File N ??? Event N ??? Function N ??? Container Instance N

Concurrency Limit: 
- Function App: 200 concurrent executions
- Container Instances: Subscription limit (default: 100)
- Event Grid: 5000 events/second
```

### Batch Processing
```
Large Volume (1000+ files):

Option 1: Event Grid (Current)
- Upload all files to pending/
- Event Grid triggers one function per file
- Parallel processing (limited by subscription)

Option 2: Azure Batch (For very large volumes)
- Upload all files
- Single trigger creates batch job
- Batch processes multiple files per node
- Cost-effective for >10,000 files
```

## Error Handling Flow

```
????????????????????????????????????????????????????????????????
?      Error Recovery        ?
????????????????????????????????????????????????????????????????

  Upload TIF
  ?
      ?
  ???????????
  ? Success??????Yes??? Continue processing
  ???????????
     ?
      No (Blob upload failed)
       ?
       ?
  ????????????????
  ? Retry 3 times?????All Failed??? Alert admin
  ????????????????
      ?
    Last Success
      ?
?
  ????????????????
  ?Event Triggered?
  ????????????????
     ?
      ?
  ???????????
  ?Function ?????Error??? Move to failed/
  ?Success? ?   Send alert
  ???????????         Log error
       ?
      Yes
       ?
 ?
  ????????????????
  ?Container Run ?????Error??? Move to failed/
  ?Success?      ?             Update job status
???????????????? Retry queue
       ?
 Yes
  ?
         ?
  ????????????????
  ?Archive File  ?
  ?Upload Results?
  ?Complete!   ?
  ????????????????
```

## Cost Breakdown (Monthly)

```
???????????????????????????????????????????????????????????????
?         Monthly Usage: 300 TIF files (10/day)     ?
???????????????????????????????????????????????????????????????

Azure Blob Storage
?? Hot tier (100 GB)            $2.30
?? Cool tier (50 GB archived)        $1.00
?? Transactions (30K operations)        $0.50
?? Data transfer (10 GB egress)            $0.90
    Subtotal: $4.70

Azure Functions (Consumption Plan)
?? Executions (300 function calls)            $0.00  (Free tier)
?? Execution time (300 × 5 sec)         $0.00  (Free tier)
?? Memory (1 GB-seconds)            $0.00  (Free tier)
         Subtotal: $0.00

Azure Container Instances
?? 300 runs × 2 minutes × $0.0000125/sec     $45.00
?? Memory (1.5 GB × 300 × 2 min)          $9.00
?? vCPU (1 core × 300 × 2 min)   $11.25
            Subtotal: $65.25

Azure OpenAI (GPT-4o-mini)
?? Input tokens (300K tokens × $0.15/1M)     $0.045
?? Output tokens (150K tokens × $0.60/1M) $0.090
?? Content Understanding API (300 pages)      $15.00
  Subtotal: $15.14

Azure Event Grid
?? Operations (300 events)            $0.60
 Subtotal: $0.60

Application Insights
?? Data ingestion (2 GB)  $5.75
?? Data retention (90 days)           $0.00  (Free)
?? Synthetic monitoring    $0.00
     Subtotal: $5.75

Database (Azure SQL Basic)
?? Database instance               $4.99
?? Storage (10 GB)     $1.16
?? Backup storage       $0.00  (Free)
       Subtotal: $6.15

?????????????????????????????????????????????????????????????
TOTAL MONTHLY COST:    $97.59
?????????????????????????????????????????????????????????????

Cost Per TIF File Processed:     $0.33
```

## Performance Characteristics

```
????????????????????????????????????????????????????????????????
? Processing Performance  ?
????????????????????????????????????????????????????????????????

Single TIF File Processing Time:
??????????????????????????????????????????????
? Stage               ? Time          ?
??????????????????????????????????????????????
? 1. Blob upload          ? 1-3 seconds      ?
? 2. Event Grid trigger   ? 1-2 seconds      ?
? 3. Function execution   ? 2-5 seconds      ?
? 4. Container start      ? 10-15 seconds    ?
? 5. OCR processing       ? 15-30 seconds    ?
? 6. OpenAI processing    ? 10-20 seconds    ?
? 7. Save results         ? 2-5 seconds      ?
? 8. Archive file         ? 1-2 seconds      ?
??????????????????????????????????????????????
? TOTAL     ? 42-82 seconds    ?
??????????????????????????????????????????????

Average: ~60 seconds per file
```

## Deployment Environments

```
?????????????????????????????????????????????????????????????????
?       Environment Strategy      ?
?????????????????????????????????????????????????????????????????

Development
?? Resource Group: rg-imageextractor-dev
?? Storage: imageextractordevstore
?? Function: imageextractor-func-dev
?? Container: imageextractordevacr
?? Cost: ~$20/month

Staging
?? Resource Group: rg-imageextractor-staging
?? Storage: imageextractorstagingstore
?? Function: imageextractor-func-staging
?? Container: imageextractorstagingacr
?? Cost: ~$50/month

Production
?? Resource Group: rg-imageextractor-prod
?? Storage: imageextractorstorage
?? Function: imageextractor-func
?? Container: imageextractoracr
?? High Availability: Yes
?? Geo-redundancy: Optional
?? Cost: ~$100/month
```

## Security Layers

```
?????????????????????????????????????????????????????????????????
?     Security Architecture             ?
?????????????????????????????????????????????????????????????????

Layer 1: Network Security
?? Private Endpoints (Optional)
?? VNet Integration
?? NSG Rules
?? Firewall Rules

Layer 2: Identity & Access
?? Managed Identity (System-assigned)
?? RBAC (Role-Based Access Control)
?? Azure AD Authentication
?? Service Principal (CI/CD)

Layer 3: Secrets Management
?? Azure Key Vault
?? Managed Identity to Key Vault
?? Secrets rotation policy
?? Access policies

Layer 4: Data Protection
?? Encryption at rest (Storage)
?? Encryption in transit (HTTPS/TLS)
?? Blob versioning
?? Soft delete (30 days)
?? Lifecycle management

Layer 5: Monitoring & Compliance
?? Azure Policy
?? Security Center
?? Audit logs
?? Compliance reports
?? Alert rules
```

---

**This architecture is:**
- ? Event-driven and serverless
- ? Scalable (handles 1000+ files/day)
- ? Cost-effective ($0.33 per file)
- ? Secure (multiple security layers)
- ? Monitored (Application Insights)
- ? Production-ready (99.95% SLA)

**Deployment time**: ~2 hours  
**Maintenance effort**: Low (serverless = less ops)  
**Learning curve**: Medium (Azure PaaS services)
