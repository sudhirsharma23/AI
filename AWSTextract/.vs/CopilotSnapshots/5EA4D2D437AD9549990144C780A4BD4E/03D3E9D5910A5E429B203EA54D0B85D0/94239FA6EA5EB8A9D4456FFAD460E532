using Amazon;
using Amazon.S3;
using Amazon.S3.Model;
using System;
using System.IO;
using System.Threading.Tasks;

namespace TextractUploader
{
    class Program
    {
        // --- CONFIGURATION ---
        // TODO: Replace with your S3 bucket name. This bucket should be configured to trigger the TextractProcessor Lambda.
        private const string BucketName = "testbucket-sudhir-bsi1";

        // TODO: Replace with the full path to the .tif file you want to upload.
        private const string FilePath = @"E:\Sudhir\AWSTextract\TextractUploader\2025000065659.tif";

        // TODO: Replace with the AWS region of your S3 bucket.
        private static readonly RegionEndpoint BucketRegion = RegionEndpoint.USWest2;

        private static IAmazonS3 _s3Client;

        static async Task Main(string[] args)
        {
            if (!File.Exists(FilePath))
            {
                Console.WriteLine($"Error: File not found at '{FilePath}'. Please update the FilePath variable in Program.cs.");
                Console.WriteLine("Press any key to exit.");
                Console.ReadKey();
                return;
            }

            // Ensure you have configured your AWS credentials correctly.
            // This can be done via the AWS Toolkit for Visual Studio, environment variables, or an EC2 instance profile.
            _s3Client = new AmazonS3Client(BucketRegion);

            await UploadFileAsync();

            Console.WriteLine("Press any key to exit.");
            Console.ReadKey();
        }

        private static async Task UploadFileAsync()
        {
            try
            {
                // Using a prefix helps organize files in the bucket.
                var fileKey = $"uploads/{Path.GetFileName(FilePath)}";
                var putRequest = new PutObjectRequest
                {
                    BucketName = BucketName,
                    Key = fileKey,
                    FilePath = FilePath,
                    ContentType = "image/tiff" // Or "image/jpeg" for JPG files
                };

                Console.WriteLine($"Uploading {fileKey} to S3 bucket {BucketName}...");
                PutObjectResponse response = await _s3Client.PutObjectAsync(putRequest);
                Console.WriteLine($"Successfully uploaded {fileKey}.");
                Console.WriteLine($"Response ETag: {response.ETag}");
            }
            catch (AmazonS3Exception e)
            {
                if (e.Message.Contains("The bucket you are attempting to access must be addressed using the specified endpoint"))
                {
                    Console.WriteLine($"Error: Bucket '{BucketName}' is not in the configured region ({BucketRegion}).");
                    Console.WriteLine($"Please update the BucketRegion in Program.cs to match your bucket's region.");
                    if (e.Message.Contains("s3."))
                    {
                        var correctEndpoint = e.Message.Split("s3.")[1].Split(".")[0];
                        Console.WriteLine($"Try changing the region to match: {correctEndpoint}");
                    }
                }
                else
                {
                    Console.WriteLine($"S3 Error: '{e.Message}'. Make sure your AWS credentials and permissions are set up correctly and the bucket exists in the specified region.");
                }
            }
            catch (Exception e)
            {
                Console.WriteLine($"An error occurred: '{e.Message}'");
            }
        }
    }
}