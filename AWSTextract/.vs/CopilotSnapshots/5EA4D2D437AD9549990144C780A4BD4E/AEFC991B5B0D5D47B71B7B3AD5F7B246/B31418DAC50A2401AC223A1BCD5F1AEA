using System.Text.Json.Serialization;

namespace TextractProcessor.Models
{
    public class BedrockModelConfig
    {
        public string ModelId { get; set; }
        public string SystemPrompt { get; set; }
        public RequestFormat RequestFormat { get; set; }
        public ResponseFormat ResponseFormat { get; set; }
        public BedrockInferenceParameters InferenceParameters { get; set; }

        public static BedrockModelConfig TitanTextExpress => new()
        {
            ModelId = "amazon.titan-text-express-v1",
            SystemPrompt = "You are an expert data extraction assistant. Your task is to transform structured data from one format into a valid JSON object that strictly adheres to a target schema. Follow all rules and output only the JSON object.",
            RequestFormat = RequestFormat.Titan,
            ResponseFormat = ResponseFormat.Titan,
            InferenceParameters = new BedrockInferenceParameters
            {
                MaxTokens = 4000,
                Temperature = 0.0f,
                TopP = 1.0f,
                StopSequences = Array.Empty<string>()
            }
        };

        public static BedrockModelConfig Claude3Haiku => new()
        {
            ModelId = "anthropic.claude-3-haiku-20240307-v1:0",
            SystemPrompt = "You are an expert data extraction assistant. Your task is to transform structured data from one format into a valid JSON object that strictly adheres to a target schema. Follow all rules and output only the JSON object.",
            RequestFormat = RequestFormat.Claude,
            ResponseFormat = ResponseFormat.Claude,
            InferenceParameters = new BedrockInferenceParameters
            {
                MaxTokens = 4000,
                Temperature = 0.7f,
                TopP = 1.0f,
                StopSequences = new[] { "Human:", "Assistant:" },
                Version = "bedrock-2023-05-31"
            }
        };

        public static BedrockModelConfig NovaLite => new()
        {
            ModelId = "aws.amazon.nova-lite-v1:0", // Using Titan as Nova requires provisioned throughput
            SystemPrompt = "You are an expert data extraction assistant. Your task is to transform structured data from one format into a valid JSON object that strictly adheres to a target schema. Follow all rules and output only the JSON object.",
            RequestFormat = RequestFormat.Nova, 
            ResponseFormat = ResponseFormat.Nova, 
            InferenceParameters = new BedrockInferenceParameters
            {
                MaxTokens = 5000,
                Temperature = 0.0f,
                TopP = 1.0f
            }
        };

        public static BedrockModelConfig Qwen3 => new()
        {
            ModelId = "alibaba.qwen2-72b-instruct",
            SystemPrompt = "You are an expert data extraction assistant. Your task is to transform structured data from one format into a valid JSON object that strictly adheres to a target schema. Follow all rules and output only the JSON object.",
            RequestFormat = RequestFormat.Qwen,
            ResponseFormat = ResponseFormat.Qwen,
            InferenceParameters = new BedrockInferenceParameters
            {
                MaxTokens = 4000,
                Temperature = 0.0f,
                TopP = 1.0f
            }
        };
    }

    public class BedrockInferenceParameters
    {
        public int MaxTokens { get; set; }
        public float Temperature { get; set; }
        public float TopP { get; set; }
        public string[] StopSequences { get; set; }
        public string Version { get; set; }
    }

    public enum RequestFormat
    {
        Titan,
        Claude,
        Nova,
        Qwen
    }

    public enum ResponseFormat
    {
        Titan,
        Claude,
        Nova,
        Qwen
    }

    public class BedrockResponse
    {
        [JsonPropertyName("results")]
        public List<TitanResult> Results { get; set; } = new();

        [JsonPropertyName("content")]
        public string Content { get; set; } = string.Empty;

        [JsonPropertyName("stop_reason")]
        public string StopReason { get; set; } = string.Empty;

        [JsonPropertyName("usage")]
        public Usage Usage { get; set; }
    }

    public class TitanResult
    {
        [JsonPropertyName("outputText")]
        public string OutputText { get; set; } = string.Empty;

        [JsonPropertyName("completionReason")]
        public string CompletionReason { get; set; } = string.Empty;

        [JsonPropertyName("inputTextTokenCount")]
        public int InputTextTokenCount { get; set; }

        [JsonPropertyName("outputTextTokenCount")]
        public int OutputTextTokenCount { get; set; }
    }

    public class Usage
    {
        [JsonPropertyName("input_tokens")]
        public int InputTokens { get; set; }

        [JsonPropertyName("output_tokens")]
        public int OutputTokens { get; set; }
    }
}
